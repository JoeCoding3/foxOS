<!doctype html>
<style>
	* {
		outline: none;
		user-select: none;
	}
    html {
        height: 100%;
    }
	body {
		background-color: black;
		color: lightgray;
	}

	button {
		background-color: lightgray;
		border-radius: 5px;
	}

    div.row {
        height: 40px;
        display: flex;
        align-items: center;
    }
    div.row:not(#sysDiv), button:not([disabled]) {
        cursor: pointer;
    }

    #refreshBtn {
        display: none;
    }
</style>
<div class="row" id="sysDiv">
    <button id="button" onclick="run()"></button>
    <button id="changeBtn" onclick="changeFolder()">Change file system folder</button>
    <button id="refreshBtn" onclick="refresh()">Refresh</button>
</div>
<script src="../../js/lib/idb.js"></script>
<script src="../../js/lib/fileutil.js"></script>
<script>
	let handle
    let currentDir
    let dirRoot
    button.focus()
	onload = async function () {
		handle = await fileutil.folder.storage.get("filesys")
		if (handle == undefined) {
            button.innerText = "Select the file system folder"
            changeBtn.style.display = "none"
        } else button.innerText = "Allow access to the file system folder"
	}
    async function run () {
        if (handle != undefined) {
            let allowed = await handle.perms()
            if (!allowed) return
        } else {
            handle = await fileutil.folder.get()
            await handle.store("filesys")
        }
        refreshBtn.style.display = "block"
        changeBtn.style.display = "none"
        button.innerText = "Parent directory"
        button.onclick = () => toParent()
        setRoot()
    }

    async function changeFolder () {
        await fileutil.folder.storage.remove("filesys")
        handle = null

        changeBtn.style.display = "none"
        button.innerText = "Select the file system folder"
        button.onclick = () => run()
        refreshBtn.style.display = "none"
    }
    function toParent () {
        changeDir(currentDir.par)
    }
	async function setRoot () {
        let files
        try {
            files = await handle.files()
        } catch (er) {
            changeFolder()
            return
        }
        let obj = {
            obj: handle,
            files: files
        }
        obj.par = obj
        dirRoot = obj
        changeDir(obj)
        document.ondblclick = async function (ev) {
            if (ev.target != document.getElementsByTagName("html")[0]) return
            let name = prompt("New folder name", "Folder")
            if (name == null) return
            await currentDir.obj.add.folder(name)
            refresh()
        }
    }
    async function changeDir (opt) {
        let files
        try {
            files = await opt.obj.files()
        } catch  (er) {
            changeDir(dirRoot)
            return
        }
        let rows = document.getElementsByClassName("row")
        for (let row of rows) {
            if (!row.id) setTimeout((row) => row.remove(), 0, row)
        }
        let fileObjs = []
        let folderObjs = []
        for (let item of files) {
            if (item.data.type == "file") fileObjs.push(item)
            else folderObjs.push(item)
        }
        for (let folder of folderObjs) addRow({
            obj: folder,
            files: files,
            par: opt
        })
        for (let file of fileObjs) addRow({
            obj: file,
            par: opt
        })
        currentDir = opt
        button.disabled = currentDir.par == currentDir
    }
    function refresh () {
        changeDir(currentDir)
    }

    function addRow (opt) {
        let data = opt.obj.data
        let type = data.type
        let name = data.name
        let row = document.createElement("div")
        row.className = "row"
        row.innerHTML = (type == "file" ? "&#128462" : "&#128448") + " " + name
        if (type == "file") {
            row.onclick = async function () {
                let name = this.data.name
                if (name.endsWith(".html")) {
                    let content = await this.read() + "<script>onunload = function () { close() }; setTimeout(() => dispatchEvent(new Event(`load`)), 100)<\\/script>"
                    let win = open(undefined, "_blank", "popup,left=0,top=0,width=" + screen.width + ",height=" + screen.height)
                    win.document.write(content)
                        
                    return
                } else await this.store("filesys_opentemp")
                if (name.endsWith(".txt") || name.endsWith(".js") || name.endsWith(".css") || name.endsWith(".trashinfo")) open("./textedit.html")
                else if (name.endsWith(".png") || name.endsWith(".jpg") || name.endsWith(".jpeg")) open("./imgedit.html")
                else open("./hexedit.html")
            }.bind(opt.obj)
            row.onmousedown = async function (ev) {
                if (ev.button != 1 || !confirm("Delete file '" + this.obj.data.name + "'?")) return
                await this.obj.delete()
                refresh()
            }.bind(opt)
            row.oncontextmenu = async function (ev) {
                ev.preventDefault()
                let name = prompt("New name", this.obj.data.name)
                if (name == null) return
                await this.obj.rename(name)
                refresh()
            }.bind(opt)
        } else if (type == "folder") {
            row.onclick = function () {
                changeDir(this)
            }.bind(opt)
            row.onmousedown = async function (ev) {
                if (ev.button != 1 || !confirm("Delete folder '" + this.obj.data.name + "'?")) return
                await this.obj.delete.self()
                refresh()
            }.bind(opt)
            row.oncontextmenu = function (ev) {
                ev.preventDefault()
                alert("Renaming folders is not supported (yet).")
            }.bind(opt)
        }
        document.body.append(row)
    }

    oncontextmenu = ev => ev.preventDefault()
</script>
