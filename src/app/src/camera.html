<!doctype html>
<style>
	* {
		user-select: none;
		outline: none;
	}
	body {
		background-color: black;
		color: lightgray;
	}
	button, input {
		background-color: lightgray;
		border-radius: 5px;
	}
	button:not([disabled]) {
		cursor: pointer;
	}
	video {
		transform: scaleX(-1);
	}
	canvas, a {
		display: none;
		cursor: pointer;
		position: absolute;
		top: 30px;
	}
</style>
<button id="startBtn" onclick="startStream()" autofocus>Start preview</button>
<button id="swapBtn" onclick="switchCameras()" disabled>Switch Cameras</button>
<button id="picBtn" onclick="takePicture()" disabled>Take picture</button>
Timer (Seconds):
<input id="timer" value="0" disabled>

<br><video id="video" muted autoplay></video>
<canvas id="small"></canvas>

<br><canvas id="photo"></canvas>
<a id="dl" download="picture.png"></a>
<script>
	let photoCtx = photo.getContext("2d")
	let smallCtx = small.getContext("2d")
	let picInt
	let origTimer
	let streaming = false
	let frontCam = true
	async function startStream (restart) {
		if (streaming || restart) {
			video.srcObject.getTracks().forEach(function (track) {
				track.stop()
			})
			if (!restart) {
				video.srcObject = null
				startBtn.innerText = "Start preview"

				picBtn.disabled = swapBtn.disabled = timer.disabled = true
			}
		}
		if (!streaming || restart) {
			if (restart) frontCam = !frontCam
			let stream = await navigator.mediaDevices.getUserMedia({
				video: {
					facingMode: {
						exact: frontCam ? "user" : "environment"
					}
				}
			})
			video.srcObject = stream
			startBtn.innerText = "Stop preview"

			video.onloadedmetadata = function () {
				photo.width = video.videoWidth
				photo.height = video.videoHeight
				small.width = video.videoWidth / 5
				small.height = video.videoHeight / 5
				small.style.left = (video.videoWidth + 15) + "px";
				
				picBtn.disabled = swapBtn.disabled = timer.disabled = false
			}
		}
		if (!restart) streaming = !streaming
	}
	function switchCameras () {
		startStream(true)
	}
	function takePicture () {
		if (isNaN(timer.value) || timer.value < 0 || timer.value == "Infinity") timer.value = 0
		timer.value = Math.round(timer.value)
		origTimer = timer.value
		picBtn.disabled = true
		capturePicture()
		picInt = setInterval(function () {
			if (timer.value >= 1) timer.value -= 1
			capturePicture()
		}, 1000)
	}
	function capturePicture () {
		if (timer.value <= 0) {
			clearInterval(picInt)
			timer.value = origTimer
			photoCtx.drawImage(video, 0, 0)
			smallCtx.drawImage(video, 0, 0, small.width, small.height)
			small.style.display = "block"
			picBtn.disabled = false
		}
	}
	small.onclick = function () {
		dl.href = photo.toDataURL()
		dl.click()
	}
</script>
